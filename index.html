<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Чат с изображениями</title>
  </head>
  <body>
    <div id="registerForm">
      <h2>Регистрация</h2>
      <input type="text" id="registerUsername" placeholder="Имя пользователя" />
      <input type="password" id="registerPassword" placeholder="Пароль" />
      <input type="file" id="registerAvatar" accept="image/*" />
      <button onclick="registerUser()">Регистрация</button>
    </div>

    <div id="loginForm">
      <h2>Авторизация</h2>
      <input type="text" id="loginUsername" placeholder="Имя пользователя" />
      <input type="password" id="loginPassword" placeholder="Пароль" />
      <button onclick="loginUser()">Войти</button>
    </div>

    <div id="messageForm" style="display: none">
      <h2>Стена сообщений</h2>
      <div id="wall"></div>
      <input type="text" id="message" placeholder="Ваше сообщение" />
      <input type="file" id="image" accept="image/*" />
      <button onclick="postMessageWithImage()">Отправить</button>
    </div>

    <script>
      function registerUser() {
        const username = document.getElementById("registerUsername").value;
        const password = document.getElementById("registerPassword").value;
        const avatarFile = document.getElementById("registerAvatar").files[0]; // Получаем выбранный файл аватара

        const formData = new FormData();
        formData.append("username", username);
        formData.append("password", password);
        if (avatarFile) {
          formData.append("avatar", avatarFile); // Добавляем файл аватара
        }

        fetch("https://data-base.up.railway.app/register", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.text())
          .then((data) => {
            alert(data);
          })
          .catch((error) => console.error("Ошибка:", error));
      }

      function loginUser() {
        const username = document.getElementById("loginUsername").value;
        const password = document.getElementById("loginPassword").value;
        fetch("https://data-base.up.railway.app/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        })
          .then((response) => response.json())
          .then((data) => {
            localStorage.setItem("token", data.token);
            document.getElementById("loginForm").style.display = "none";
            document.getElementById("registerForm").style.display = "none";
            document.getElementById("messageForm").style.display = "block";
            fetchMessages();
          })
          .catch((error) => console.error("Ошибка:", error));
      }

      function fetchMessages() {
        fetch("https://data-base.up.railway.app/getMessages")
          .then((response) => response.json())
          .then((messages) => {
            const wall = document.getElementById("wall");
            wall.innerHTML = ""; // Очистить стену перед добавлением новых сообщений
            messages.forEach((msg) => {
              const messageElement = document.createElement("div");
              messageElement.classList.add("message");

              let messageContent = `<img src="${msg.avatar}" alt="${msg.avatar}" class="avatar" style="width: 50px; height: 50px; border-radius: 50%;"> 
                                      <span class="username">${msg.username}:</span> ${msg.message}`;
              if (msg.image) {
                messageContent += `<br><img src="${msg.image}" alt="Message Image" width="200">`;
              }

              messageElement.innerHTML = messageContent;
              wall.appendChild(messageElement);
            });
          })
          .catch((error) => console.error("Ошибка:", error)); // Обработка ошибок
      }

      function postMessageWithImage() {
        const message = document.getElementById("message").value;
        const image = document.getElementById("image").files[0];
        const token = localStorage.getItem("token");

        const formData = new FormData();
        formData.append("message", message);
        if (image) {
          formData.append("image", image);
        }

        fetch("https://data-base.up.railway.app/postMessageWithImage", {
          method: "POST",
          headers: {
            Authorization: token,
          },
          body: formData,
        })
          .then((response) => response.text())
          .then((data) => {
            console.log(data);
            document.getElementById("message").value = "";
            document.getElementById("image").value = "";
          })
          .catch((error) => console.error("Ошибка:", error));
      }

      // Подписка на события для обновления сообщений
      const eventSource = new EventSource(
        "https://data-base.up.railway.app/events"
      );
      eventSource.onmessage = function (event) {
        if (event.data === "update") {
          fetchMessages();
        }
      };
    </script>
  </body>
</html>
